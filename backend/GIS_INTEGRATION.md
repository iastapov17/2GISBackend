# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 2GIS API –¥–ª—è —Å–ª–æ—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏

## üìã –û–±–∑–æ—Ä

–î–ª—è —Å–ª–æ—è **"light" (–æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å)** —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ [2GIS Places API](https://docs.2gis.com/ru/api/search/places/reference/3.0/items).

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

1. **–ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ü–µ–Ω—Ç—Ä–æ–≤** –≤ –∑–∞–¥–∞–Ω–Ω–æ–º bbox —á–µ—Ä–µ–∑ 2GIS API
2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç** (items.point) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–¶
3. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–æ–≤** (–∫—Ä—É–≥–∏ —Ä–∞–¥–∏—É—Å–æ–º 100–º) –≤–æ–∫—Ä—É–≥ –¢–¶
4. **–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª–∏–≥–æ–Ω–æ–≤** —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏

### –ü–æ—á–µ–º—É —Ç–æ—Ä–≥–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã?

- –¢–¶ –æ–±—ã—á–Ω–æ **—Ö–æ—Ä–æ—à–æ –æ—Å–≤–µ—â–µ–Ω—ã** –∫–∞–∫ –≤–Ω—É—Ç—Ä–∏, —Ç–∞–∫ –∏ —Å–Ω–∞—Ä—É–∂–∏
- –í–æ–∫—Ä—É–≥ –¢–¶ –µ—Å—Ç—å **—É–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
- –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ **2GIS API** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

---

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. `GisService` (app/services/gis_service.py)

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å 2GIS Places API:

```python
class GisService:
    async def get_shopping_centers(bbox) -> List[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –¢–¶ –∏–∑ 2GIS API"""
        # GET https://catalog.api.2gis.com/3.0/items
        # params: q="—Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä", viewpoint1, viewpoint2
        
    def create_polygon_around_point(lat, lon, radius_m=100) -> List[List[float]]:
        """–°–æ–∑–¥–∞—Ç—å –∫—Ä—É–≥–ª—ã–π –ø–æ–ª–∏–≥–æ–Ω –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏"""
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 16 —Ç–æ—á–µ–∫ –¥–ª—è –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏–∏ –∫—Ä—É–≥–∞
        
    async def get_light_polygons(bbox) -> List[Dict]:
        """–ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –¥–≤–∞ –º–µ—Ç–æ–¥–∞ –≤—ã—à–µ"""
```

### 2. `PolygonLoader` (app/data/polygon_loader.py)

–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:

```python
class PolygonLoader:
    def __init__(self, gis_service=None):
        # –î–ª—è —Å–≤–µ—Ç–∞: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2GIS API, fallback JSON —Ñ–∞–π–ª
        
    async def find_polygons_in_bbox_async(layer_type, bbox):
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª–∏–≥–æ–Ω–æ–≤:
        - light: —Å–Ω–∞—á–∞–ª–∞ 2GIS, –ø–æ—Ç–æ–º —Ñ–∞–π–ª
        - –æ—Å—Ç–∞–ª—å–Ω—ã–µ: —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã
        """
```

### 3. `MockDataGenerator` (app/data/mock_data.py)

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ:

```python
class MockDataGenerator:
    def __init__(self, gis_service=None):
        self.polygon_loader = get_polygon_loader(gis_service)
        
    async def generate_segments_in_bbox_async(layer_type, bbox):
        """
        –î–ª—è —Å–≤–µ—Ç–∞: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç polygon_loader.find_polygons_in_bbox_async
        """
```

### 4. `MapService` (app/services/map_service.py)

–ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–ª–æ—è–º–∏:

```python
class MapService:
    def __init__(self):
        self.gis_service = get_gis_service()
        self.mock_generator = MockDataGenerator(gis_service=self.gis_service)
        
    async def get_layer_data(layer_type, bbox):
        """
        –î–ª—è —Å–≤–µ—Ç–∞: –≤—ã–∑—ã–≤–∞–µ—Ç generate_segments_in_bbox_async
        –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö: —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥
        """
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### API Endpoint

```bash
GET /api/v1/layers/light?bbox=55.75,37.61,55.76,37.63
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏:

1. MapService –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ª–æ–π "light"
2. –í—ã–∑—ã–≤–∞–µ—Ç MockDataGenerator.generate_segments_in_bbox_async("light", bbox)
3. –¢–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç PolygonLoader.find_polygons_in_bbox_async("light", bbox)
4. PolygonLoader –≤—ã–∑—ã–≤–∞–µ—Ç GisService.get_light_polygons(bbox)
5. GisService:
   - –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ 2GIS API: `GET /3.0/items?q=—Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä&...`
   - –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¢–¶ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–¶ —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª–∏–≥–æ–Ω —Ä–∞–¥–∏—É—Å–æ–º 100–º
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–∏–≥–æ–Ω—ã —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏:
   ```json
   {
     "id": "light_tc_12345",
     "coordinates": [[lon, lat], ...],
     "street_name": "–¢–¶ –ê—Ç—Ä–∏—É–º",
     "metrics": {
       "light_lux": 180.0,  // –•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
       "noise_db": 65.0,
       "crowd_level": 4
     }
   }
   ```

---

## üéØ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã 2GIS API

### –ó–∞–ø—Ä–æ—Å –∫ /3.0/items

```
GET https://catalog.api.2gis.com/3.0/items
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|----------|----------|--------|
| `q` | –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å | `—Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä` |
| `region_id` | ID —Ä–µ–≥–∏–æ–Ω–∞ | `1` (–ú–æ—Å–∫–≤–∞) |
| `viewpoint1` | –õ–µ–≤–∞—è –Ω–∏–∂–Ω—è—è —Ç–æ—á–∫–∞ bbox | `37.61,55.75` |
| `viewpoint2` | –ü—Ä–∞–≤–∞—è –≤–µ—Ä—Ö–Ω—è—è —Ç–æ—á–∫–∞ bbox | `37.63,55.76` |
| `type` | –¢–∏–ø –æ–±—ä–µ–∫—Ç–æ–≤ | `branch` |
| `fields` | –ü–æ–ª—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ | `items.point` |
| `page_size` | –ö–æ–ª-–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ | `50` |
| `key` | API –∫–ª—é—á (–æ–ø—Ü.) | `–≤–∞—à_–∫–ª—é—á` |

### –û—Ç–≤–µ—Ç

```json
{
  "result": {
    "items": [
      {
        "id": "70000001234567",
        "name": "–¢–¶ –ê—Ç—Ä–∏—É–º",
        "point": {
          "lat": 55.753,
          "lon": 37.621
        }
      }
    ]
  }
}
```

---

## üîê API –ö–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á:

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å:

1. **–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** (app/core/config.py):
   ```python
   class Settings(BaseSettings):
       gis_api_key: Optional[str] = None
   ```

2. **–í .env**:
   ```
   GIS_API_KEY=your_api_key_here
   ```

3. **–í GisService**:
   ```python
   from app.core.config import settings
   
   class GisService:
       def __init__(self):
           self.api_key = settings.gis_api_key
   ```

---

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –†–∞–¥–∏—É—Å –ø–æ–ª–∏–≥–æ–Ω–∞

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 100 –º–µ—Ç—Ä–æ–≤. –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:

```python
# app/services/gis_service.py
def create_polygon_around_point(
    lat, lon, 
    radius_m: int = 150,  # ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –∑–¥–µ—Å—å
    num_points: int = 16
)
```

### –ú–µ—Ç—Ä–∏–∫–∏ —Å–≤–µ—Ç–∞

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –¢–¶ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è 180 lux:

```python
# app/services/gis_service.py
polygons.append({
    "metrics": {
        "light_lux": 180.0,  # ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –∑–¥–µ—Å—å
        # ...
    }
})
```

### Fallback –Ω–∞ —Ñ–∞–π–ª

–ï—Å–ª–∏ 2GIS API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª:

```
backend/app/data/polygons_light.json
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
cd backend
/usr/bin/python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ª–æ–π —Å–≤–µ—Ç–∞ (–ú–æ—Å–∫–≤–∞)

```bash
curl "http://localhost:8000/api/v1/layers/light?bbox=55.75,37.61,55.76,37.63"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```
‚úÖ [LIGHT] –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è 2GIS API –¥–ª—è –ø–æ–∏—Å–∫–∞ –¢–¶
‚úÖ [2GIS] –ù–∞–π–¥–µ–Ω–æ 15 —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ü–µ–Ω—Ç—Ä–æ–≤
‚úÖ [2GIS] –°–æ–∑–¥–∞–Ω–æ 15 –ø–æ–ª–∏–≥–æ–Ω–æ–≤ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –∏–∑ –¢–¶
‚úÖ [LIGHT] –ò—Å–ø–æ–ª—å–∑—É–µ–º 15 —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª–∏–≥–æ–Ω–æ–≤
```

### 4. –ï—Å–ª–∏ 2GIS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:

```
‚ö†Ô∏è [LIGHT] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ 2GIS, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
‚öôÔ∏è [LIGHT] –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 30 —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–∏–≥–æ–Ω–æ–≤
```

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –∫ 2GIS**: ~200-500ms
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¢–¶ –≤ –ú–æ—Å–∫–≤–µ (—Ü–µ–Ω—Ç—Ä)**: 15-50 —à—Ç
- **–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞**: ~10-50 KB

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ N –º–∏–Ω—É—Ç
2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ** `page_size` –¥–æ 50
3. **–¢–∞–π–º–∞—É—Ç** –∑–∞–ø—Ä–æ—Å–∞ 10 —Å–µ–∫—É–Ω–¥

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ 2GIS –æ—Ç–≤–µ—á–∞–µ—Ç:

```bash
curl "https://catalog.api.2gis.com/3.0/items?q=—Ç–æ—Ä–≥–æ–≤—ã–π%20—Ü–µ–Ω—Ç—Ä&region_id=1&viewpoint1=37.61,55.75&viewpoint2=37.63,55.76&type=branch&fields=items.point&page_size=10"
```

### –õ–æ–≥–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:

```python
# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
‚úÖ [NOISE] –ó–∞–≥—Ä—É–∂–µ–Ω–æ 14554 –ø–æ–ª–∏–≥–æ–Ω–æ–≤ –∏–∑ app/data/polygons_noise.json
‚úÖ [LIGHT] –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è 2GIS API –¥–ª—è –ø–æ–∏—Å–∫–∞ –¢–¶
‚ö†Ô∏è [CROWD] –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: app/data/polygons_crowd.json
‚ö†Ô∏è [PUDDLES] –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: app/data/polygons_puddles.json
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è 2GIS

- [Places API Reference](https://docs.2gis.com/ru/api/search/places/reference/3.0/items)
- [–ü–æ–∏—Å–∫ –º–µ—Å—Ç](https://docs.2gis.com/ru/api/search/places/overview)

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

–í–º–µ—Å—Ç–æ –¢–¶ –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å:
- **–û—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞** (—Ö–æ—Ä–æ—à–æ –æ—Å–≤–µ—â–µ–Ω—ã)
- **–ë–∞–Ω–∫–æ–º–∞—Ç—ã** (–æ–±—ã—á–Ω–æ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π)
- **–ü–∞—Ä–∫–æ–≤–∫–∏** (–æ—Å–≤–µ—â–µ–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

–ò–∑–º–µ–Ω–∏—Ç—å –≤ `GisService.get_shopping_centers()`:

```python
params = {
    "q": "–æ—Å—Ç–∞–Ω–æ–≤–∫–∞",  # ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
    # ...
}
```

---

## ‚úÖ –ò—Ç–æ–≥–æ

üéâ –¢–µ–ø–µ—Ä—å —Å–ª–æ–π —Å–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** –∏–∑ 2GIS API!

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ü–µ–Ω—Ç—Ä–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–æ–≤ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –¢–¶
- ‚úÖ Fallback –Ω–∞ —Ñ–∞–π–ª –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

